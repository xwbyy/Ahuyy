// Initialize variables
let audioPlaying = false;
const weddingAudio = document.getElementById('weddingAudio');
const messages = [];

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    initializePreloader();
    initializeParticles();
    initializeNavigation();
    initializeCountdown();
    initializeGallery();
    initializeRSVPForm();
    initializeAudio();
    initializeOpenInvitation();
    initializeMessages();
});

// Preloader
function initializePreloader() {
    const preloader = document.getElementById('preloader');
    const progress = document.querySelector('.progress');
    
    // Simulate loading progress
    let width = 0;
    const interval = setInterval(() => {
        if (width >= 100) {
            clearInterval(interval);
            setTimeout(() => {
                preloader.style.opacity = '0';
                setTimeout(() => {
                    preloader.style.display = 'none';
                }, 500);
            }, 500);
        } else {
            width += 5;
            progress.style.width = width + '%';
        }
    }, 100);
}

// Particles background
function initializeParticles() {
    const particlesContainer = document.getElementById('particles');
    const particleCount = 50;
    
    for (let i = 0; i < particleCount; i++) {
        createParticle(particlesContainer);
    }
}

function createParticle(container) {
    const particle = document.createElement('div');
    particle.classList.add('particle');
    
    // Random size between 3 and 8 pixels
    const size = Math.random() * 5 + 3;
    particle.style.width = `${size}px`;
    particle.style.height = `${size}px`;
    
    // Random position
    particle.style.left = `${Math.random() * 100}%`;
    particle.style.top = `${Math.random() * 100}%`;
    
    // Random animation duration between 10 and 30 seconds
    const duration = Math.random() * 20 + 10;
    particle.style.animationDuration = `${duration}s`;
    
    // Random delay
    particle.style.animationDelay = `-${Math.random() * 20}s`;
    
    container.appendChild(particle);
}

// Navigation
function initializeNavigation() {
    const nav = document.getElementById('nav');
    const navToggle = document.getElementById('navToggle');
    const navMenu = document.getElementById('navMenu');
    const navLinks = document.querySelectorAll('.nav-link');
    
    // Sticky navigation on scroll
    window.addEventListener('scroll', () => {
        if (window.scrollY > 50) {
            nav.classList.add('scrolled');
        } else {
            nav.classList.remove('scrolled');
        }
    });
    
    // Mobile navigation toggle
    navToggle.addEventListener('click', () => {
        navToggle.classList.toggle('active');
        navMenu.classList.toggle('active');
    });
    
    // Close mobile menu when clicking on a link
    navLinks.forEach(link => {
        link.addEventListener('click', () => {
            navToggle.classList.remove('active');
            navMenu.classList.remove('active');
        });
    });
}

// Countdown timer
function initializeCountdown() {
    const weddingDate = new Date('2026-07-15T08:00:00');
    
    function updateCountdown() {
        const now = new Date();
        const timeRemaining = weddingDate - now;
        
        if (timeRemaining <= 0) {
            document.getElementById('days').textContent = '00';
            document.getElementById('hours').textContent = '00';
            document.getElementById('minutes').textContent = '00';
            document.getElementById('seconds').textContent = '00';
            return;
        }
        
        const days = Math.floor(timeRemaining / (1000 * 60 * 60 * 24));
        const hours = Math.floor((timeRemaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeRemaining % (1000 * 60)) / 1000);
        
        document.getElementById('days').textContent = days.toString().padStart(2, '0');
        document.getElementById('hours').textContent = hours.toString().padStart(2, '0');
        document.getElementById('minutes').textContent = minutes.toString().padStart(2, '0');
        document.getElementById('seconds').textContent = seconds.toString().padStart(2, '0');
    }
    
    // Update countdown immediately and then every second
    updateCountdown();
    setInterval(updateCountdown, 1000);
}

// Gallery modal
function initializeGallery() {
    const galleryItems = document.querySelectorAll('.gallery-item');
    const modal = document.getElementById('galleryModal');
    const modalImage = document.getElementById('modalImage');
    const modalClose = document.getElementById('modalClose');
    
    galleryItems.forEach(item => {
        item.addEventListener('click', () => {
            const imgSrc = item.querySelector('img').src;
            modalImage.src = imgSrc;
            modal.classList.add('open');
            document.body.style.overflow = 'hidden';
        });
    });
    
    modalClose.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeModal();
        }
    });
    
    function closeModal() {
        modal.classList.remove('open');
        document.body.style.overflow = 'auto';
    }
}

// RSVP Form
function initializeRSVPForm() {
    const rsvpForm = document.getElementById('rsvpForm');
    
    rsvpForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(rsvpForm);
        const name = formData.get('name');
        const attendance = formData.get('attendance');
        const message = formData.get('message');
        
        // Create message object
        const newMessage = {
            name: name,
            attendance: attendance,
            message: message,
            date: new Date().toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            })
        };
        
        // Add to messages array
        messages.push(newMessage);
        
        // Save to localStorage
        saveMessages();
        
        // Update guestbook display
        displayMessages();
        
        // Show success toast
        showToast('Konfirmasi kehadiran Anda telah berhasil dikirim!');
        
        // Reset form
        rsvpForm.reset();
    });
}

// Audio player
function initializeAudio() {
    const playAudioBtn = document.getElementById('playAudio');
    
    playAudioBtn.addEventListener('click', function() {
        if (audioPlaying) {
            weddingAudio.pause();
            playAudioBtn.innerHTML = '<i class="fas fa-music"></i>';
            playAudioBtn.classList.remove('playing');
        } else {
            weddingAudio.play().catch(error => {
                console.log('Audio play failed:', error);
                showToast('Klik sekali lagi untuk memutar musik');
            });
            playAudioBtn.innerHTML = '<i class="fas fa-pause"></i>';
            playAudioBtn.classList.add('playing');
        }
        audioPlaying = !audioPlaying;
    });
    
    // Handle audio autoplay restrictions
    document.addEventListener('click', function() {
        if (weddingAudio.paused && !audioPlaying) {
            weddingAudio.play().then(() => {
                audioPlaying = true;
                playAudioBtn.innerHTML = '<i class="fas fa-pause"></i>';
                playAudioBtn.classList.add('playing');
            }).catch(error => {
                // Autoplay was prevented, user interaction is required
                console.log('Autoplay prevented:', error);
            });
        }
    }, { once: true });
}

// Open invitation button
function initializeOpenInvitation() {
    const openInvitationBtn = document.getElementById('openInvitation');
    
    openInvitationBtn.addEventListener('click', function() {
        // Scroll to the couple section
        document.getElementById('couple').scrollIntoView({
            behavior: 'smooth'
        });
        
        // Show a welcome toast
        showToast('Terima kasih telah membuka undangan kami!');
    });
}

// Guestbook messages
function initializeMessages() {
    const refreshBtn = document.getElementById('refreshMessages');
    
    // Load messages from localStorage
    loadMessages();
    
    // Display messages
    displayMessages();
    
    // Refresh messages button
    refreshBtn.addEventListener('click', function() {
        // Rotate icon
        refreshBtn.style.transition = 'transform 0.5s ease';
        refreshBtn.style.transform = 'rotate(360deg)';
        
        setTimeout(() => {
            refreshBtn.style.transform = 'rotate(0deg)';
        }, 500);
        
        // Reload messages
        loadMessages();
        displayMessages();
        
        showToast('Pesan diperbarui');
    });
}

// Load messages from localStorage
function loadMessages() {
    const storedMessages = localStorage.getItem('weddingMessages');
    if (storedMessages) {
        try {
            const parsedMessages = JSON.parse(storedMessages);
            // Clear current messages and replace with stored ones
            messages.length = 0;
            parsedMessages.forEach(msg => messages.push(msg));
        } catch (error) {
            console.error('Error parsing messages:', error);
        }
    }
}

// Save messages to localStorage
function saveMessages() {
    try {
        localStorage.setItem('weddingMessages', JSON.stringify(messages));
    } catch (error) {
        console.error('Error saving messages:', error);
    }
}

// Display messages in the guestbook
function displayMessages() {
    const messagesContainer = document.getElementById('messagesContainer');
    
    // Clear the container
    messagesContainer.innerHTML = '';
    
    if (messages.length === 0) {
        // Show empty state
        messagesContainer.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-comments"></i>
                <p>Belum ada pesan. Jadilah yang pertama mengirimkan ucapan!</p>
            </div>
        `;
        return;
    }
    
    // Show latest messages first (reverse order)
    const reversedMessages = [...messages].reverse();
    
    reversedMessages.forEach(msg => {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message-card');
        
        const attendanceIcon = msg.attendance === 'yes' 
            ? '<i class="fas fa-check-circle" style="color: #28a745;"></i>' 
            : '<i class="fas fa-times-circle" style="color: #dc3545;"></i>';
        
        messageElement.innerHTML = `
            <div class="message-header">
                <span class="message-name">${msg.name}</span>
                <span class="message-date">${msg.date}</span>
            </div>
            <div class="message-text">
                ${attendanceIcon} ${msg.message || 'Tidak ada pesan tambahan'}
            </div>
        `;
        
        messagesContainer.appendChild(messageElement);
    });
}

// Toast notification
function showToast(message) {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    
    toastMessage.textContent = message;
    toast.classList.add('show');
    
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

// Google Sheets integration (for future use)
function submitToGoogleSheets(formData) {
    // This is a placeholder for Google Sheets integration
    // You would need to set up a Google Apps Script to handle form submissions
    console.log('Submitting to Google Sheets:', formData);
    
    // Example fetch request (would need to be configured with your Google Apps Script URL)
    /*
    fetch('YOUR_GOOGLE_APPS_SCRIPT_URL', {
        method: 'POST',
        mode: 'no-cors',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(() => {
        showToast('Konfirmasi kehadiran Anda telah berhasil dikirim!');
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Terjadi kesalahan. Silakan coba lagi.');
    });
    */
}